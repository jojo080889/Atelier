<% if current_user.can_critique? @entry %>
  <%= form_for [@project, @entry, @critique] do |f| %>
    <% if @critique.errors.any? %>
      <div id="error_explanation">
        <h2><%= pluralize(@critique.errors.count, "error") %> prohibited this critique from being saved:</h2>

        <ul>
        <% @critique.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
        </ul>
      </div>
    <% end %>

    <div class="field text">
      <%= f.text_area :text, size: "20x6", placeholder: "Write your critique for this entry here...", data: {provide: "markdown"} %>
    </div>
    <% if @entry.user.skill_level != "Advanced" %>
      <div class="rating-info">
        <%= link_to @entry.user.username, @entry.user %> has <%= pluralize(@entry.user.next_tier_ratings, "entry rating") %> of <%= @entry.user.next_tier %> -- needs <%= 5 - @entry.user.next_tier_ratings %> more to become a <%= @entry.user.next_tier %> user
      </div>
      <div class="field nominate">
        <div class="rating-label">
          Rate the overall quality of the project entry:
        </div>
        <div class="rating-container btn-group">
          <% if @entry.user.skill_level == "Beginner" %>
            <a class="rating beginner btn btn-default <%= "btn-warning" if @entry.user.skill_level == "Beginner" %>">
              <% if @entry.user.skill_level == "Beginner" %>
                <%= fa_icon "star" %>
              <% else %>
                <%= fa_icon "star-o" %>
              <% end %>
              Beginner
            </a>
          <% end %>

          <a class="rating intermediate btn btn-default <%= "btn-warning" if @entry.user.skill_level == "Intermediate" %>">
            <% if @entry.user.skill_level == "Intermediate" %>
              <%= fa_icon "star" %>
            <% else %>
              <%= fa_icon "star-o" %>
            <% end %>
            Intermediate
          </a>

          <a class="rating advanced btn btn-default">
            <%= fa_icon "star-o" %>
            Advanced
          </a>
        </div>
        <%= f.hidden_field :rating, :value => skill_level_to_rating(@entry.user.skill_level) %>
      </div>
    <% end %>
    <div class="actions">
      <%= f.submit "Post", class: "btn btn-default" %>
    </div>
  <% end %>
<% elsif current_user.id != @entry.user.id %>
  <div class="alert alert-info">
    You are not yet at a high enough skill level (or too high of a skill level) to critique this project entry.
  </div>
<% end %>

<script>
  $(".edit_critique .nominate .rating.btn, .new_critique .nominate .rating.btn").click(function() {
    if (!$(this).hasClass("btn-warning")) {
      $(this).siblings(".rating").removeClass("btn-warning");
      $(".fa-star", $(this).siblings(".rating")).removeClass("fa-star").addClass("fa-star-o");
      $(this).addClass("btn-warning");
      $(".fa-star-o", $(this)).removeClass("fa-star-o").addClass("fa-star");

      var skill_rating = 0;
      if ($(this).hasClass("beginner")) {
        skill_rating = <%= skill_level_to_rating("Beginner") %>
      } else if ($(this).hasClass("intermediate")) {
        skill_rating = <%= skill_level_to_rating("Intermediate") %>
      } else if ($(this).hasClass("advanced")) {
        skill_rating = <%= skill_level_to_rating("Advanced") %>
      }
      $(".nominate #critique_rating").val(skill_rating);
    }
  });
</script>
